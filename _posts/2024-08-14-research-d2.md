---
title: Day 14
date: 2024-08-14 05:00:00 +0200
categories: [research, setup]
tags: [research, test]     # TAG names should always be lowercase
---


# We can connect through Remote Desktop to the Ubuntu Server

So, as you can see down below, we managed to get remote access through xrdp protocol to the ubuntu server.

![image](assets/images/Pasted image 20240814005419.png)
_Remote Desktop connection through Remmina application_

I have to be honest. I don't know what I did wrong when configuring xrdp! I guess it's one of those times, uh?!

# So, let's implement OPNSense router in the remote server

Anyways, moving through, shall we configure our OPNSense router?

So, remember that we needed to configure a router? Here, take a look on the below figure, can you spot the three routers we need:

![alt text](assets/images/proposednetwork.png)

No? How about now?

![alt text](assets/images/proposednetwork-routers.png)

and, as you can see, we need to create dedicated tunnels between them.

But one step at a time! 

Let's start with the deployment of the first OPNSense Router in server 1.

The first idea that comes to my mind is to check the OPNSense documentation, maybe youtube tutorials, chatgpt, etc.

But, stop, we are engineers! we are methodic! 

I am capable of figuring this problem out!

**First, this installation is virtual, so we need to know what `computational resources` do we need for this router. Then, we need to find some sort of `initial configuration`. Then, we move into `advanced configuration`.**

# Found some computational requirements for the OPNsense VM

This link [Hardware Sizing & Setup](https://docs.opnsense.org/manual/hardware.html) contains the minimum requirements to install a virtual local machine of OPNSense. The picture also depicts it:

![alt text](assets/images/opnsense-requirements.png)

This link [Installation](https://docs.opnsense.org/manual/install.html) contains the related to the installation process **but I don't find it that much useful since it does not contain a guide on virtualbox**.

We quickly check this opnsense documentation ([link](https://docs.opnsense.org/manual/install.html))

So, on the ladder link, opnsense documentation says we need to setup our virtual machine with the following minimum requirements:

- RAM: 4096 MB
- Processor: 1
- Storage: 50 GB
- Network: **It does not mention it**

# But, in the documentation we didn't found specs or suggestions for the network adapters of OPNsense router 
[Little trouble here]
Wait, what???

The official documentation doesn't mention anything about network interfaces in a virtual local installation? 

You can check it out here [link](https://docs.opnsense.org/manual/virtuals.html#local-server). And, it is a little bit surprising because it leads you to think ... I mean, we are implementing a router, right? Routers connect two or more networks. Therefore, when configuring a virtual router, we design how many networks we will directly connect. But, the documentation does not mention or suggests any network-interface configuration. And, this is not a simple issue because, in virtualbox, you can choose a network interface to be _nat, bridge, only-host_ type, etc. So, it's not so simple as _just pick 2, and be this and that_.
[End of Little trouble]

# Then, we decide to check some video tutorials

How about if we go straight to a youtube video.

So, this is the video for reference that I will use to configure the interfaces of the vm: [link](https://www.youtube.com/watch?v=NE5xzb-qJgA)

Minute 1:22 suggests to go, in VirtualBox, to `Tools > Network > Host-only Networks > Create > vboxnet0` (it will create its own ip range)

Minute 1:34 suggests to setup two network adapters in the VM. Adapter 1 to be setup as _Bridge Network_ (pointing to the actual ethernet interface of the server) and Adapter 2 to be setup as _Host-Only Adapter_, selecting the _vboxnet0_ network that we just created.

The author takes note of both mac addresses as a future reference for acknowledging which interface to configure at OPNsense dashboard.

# Now, let's try to really create the OPNsense router

### Let's connect to our remote server and create the vm:

This are Remmina config to access it (of course, I won't reveal sensible data):
![alt text](assets/images/xrdp-credentials.png)

We connect and ... 

Here we have a remote desktop connection to our remote server:

![alt text](assets/images/rs.png)

# Little note here:

### Problem with XRDP and remote multiple sessions:

Now, for some reason, every time that I logout from my user session in the Remmina -remote-desktop- connection, the server does not accept my user password when trying to log-in again.

I spent so much time trying to solve that issue but I coulnd't. I will put some references here to quote what am I talking about:

- [xRDP - xRDP shows only black screen after authentication windows - HowToFix!](https://c-nergy.be/blog/?p=16682)
- [xRDP - Allow muktiple sessions (local and remote) for the same user - HowTo](https://c-nergy.be/blog/?p=16698)
- [xRDP - cannot read /etc/xrdp/key.pem. Permission denied error explain](https://c-nergy.be/blog/?p=13708)

# ... Back to the OPNsense router VM Creation

### VM system

![alt text](assets/images/opnrouter1-system.png)
![alt text](assets/images/opnrouter1-processor.png)
![alt text](assets/images/opnrouter1-space.png)

### VM network

![alt text](assets/images/opnrouter1-network1.png)
![alt text](assets/images/opnrouter1-network2.png)

# ... we hit start ... and, we found some problems

There is an error when starting this vm:

![alt text](assets/images/problems-vm.png)

_VirtualBox - Guru Meditation_

_A critical error has occurred while running the virtual machine and the machine execution has been stopped._

The message suggests us to inspect the file `VBox.log` and that's what we do:

```bash
oscar@itm2:~$ cat VirtualBox\ VMs/OPNSense1/Logs/VBox.log | grep ERROR
00:00:00.938704 ERROR [COM]: aRC=NS_ERROR_INVALID_ARG (0x80070057) aIID={4680b2de-8690-11e9-b83d-5719e53cf1de} aComponent={DisplayWrap} aText={Argument aWidth is invalid (must be aWidth != 0 && aWidth <= 32767)}, preserve=false aResultDetail=0
```

# Also, there is another warning pop up, and, I don't know if it's related to the same issue that is causing the vm not to work:

![alt text](assets/images/vbox-warning.png)

We tried disabling the audio on the vm but apparently, it didn't solve the _critical error_ problem.

We inspect again the `VBox.log` file:

```bash
oscar@itm2:~$ cat VirtualBox\ VMs/OPNSense1/Logs/VBox.log | grep ERROR
00:00:00.902734 [/Devices/mc146818/ERROR [COM]: aRC=NS_ERROR_INVALID_ARG (0x80070057) aIID={4680b2de-8690-11e9-b83d-5719e53cf1de} aComponent={DisplayWrap} aText={Argument aWidth is invalid (must be aWidth != 0 && aWidth <= 32767)}, preserve=false aResultDetail=0
00:00:54.393083 ERROR [COM]: aRC=NS_ERROR_INVALID_ARG (0x80070057) aIID={4680b2de-8690-11e9-b83d-5719e53cf1de} aComponent={DisplayWrap} aText={Argument aWidth is invalid (must be aWidth != 0 && aWidth <= 32767)}, preserve=false aResultDetail=0
```

I decided to perform a google search of the error:

![alt text](assets/images/vboxlog-error.png)

and on the second result is a forum, and click there ([link](https://forums.linuxmint.com/viewtopic.php?t=424497)) and the first message contains the same error I am getting in `VBox.log`:

![alt text](assets/images/forum-error.png)

so, apparently the solution everyone converges is to upgrade the virtualbox to 7.0 version.

I follow the steps from the virtualbox official documentation to install virtualbox 7.0 [link](https://www.virtualbox.org/wiki/Linux_Downloads)

and it worked!!!

Now, you can see that virtualbox is loading the OPNsense router dashboard.

![alt text](assets/images/opnsense-dashboard.png)





S
so 
and we 
The credentials to access 

- root:opnsense
- installer:opnsense

